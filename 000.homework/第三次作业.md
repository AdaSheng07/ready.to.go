# Practice Summary 3

### 如何实现电梯的核心功能？

- 电梯在没有人按按钮的时候停留在当前所在楼层不动
- 当有人按电梯后，电梯即刻出发到达对应楼层
- 电梯将乘客送往目的楼层，每秒钟走一层楼
- 如果有多人按电梯，电梯按照如下规则行进：
  - 电梯向第一个按按钮的楼层出发
  - 如果中途有其他楼层也按了，到对应楼层时暂停、开门、关门，重新继续原来方向行进
  - 如果已经到达目的地，但还有同方向的目的楼层时，电梯维持原有方向继续行进，直到该方向最后一个楼层
  - 到最后一个目的后，如果另一个方向还有未到达楼层，则电梯调转方向，逐个送到最后目的地，直到所有目标都送达
- 注意：
  - 电梯有方向，按楼层没有方向
  - 电梯在确定行进方向时，按照按目标楼层的顺序自动决定要行进的方向
- 要求：
  - 使用 TDD 来进行开发
  - 使用面向对象设计（封装）
  - 所有函数、成员方法要符合函数方法论一节课的内容

## 电梯部署核心功能服务

### 问题分析思路

从案例角度出发，观察并归纳电梯的工作流程，列出所有的相关元素：
1. 初始化电梯和楼层的信息，作为已知条件：
   - 总楼层数量 
   - 电梯当前所在的楼层
   - 电梯的目标楼层
2. 根据设定的电梯运行规则，规划到达所有目标楼层的顺序：
   - 目标楼层到达顺序（如何计算得到？）
3. 按照规划的到达目标楼层的顺序，运行电梯并做记录：
   - 部署电梯的行进方向
   - 统计电梯的运行时间
   - 记录电梯最终停靠的楼层
   - 打印电梯的工作日志（部署的整体方法）

对列出的所有元素进行分类，大体分为属性和方法：

| 属性（成员变量）  | 方法（成员函数）     | 备注                                      |
|-----------|--------------|-----------------------------------------|
| 总楼层数量     |              | 输入数据                                    |
| 电梯当前所在的楼层 |              | 输入数据                                    |
| 电梯的目标楼层   |              | 输入数据                                    |
| 目标楼层的到达顺序 |              | 依据行进规则和输入数据，计算后得到结果                     |
|           | 目标楼层的到达顺序的计算 | 依据行进规则和输入数据进行计算规划                       |
|           | 部署电梯行进方向     | 依据目标楼层的到达顺序确定电梯初始的运行方向                  |
| 电梯运行所需时间  |              | 在电梯运行的过程中统计更新                           |
| 电梯最终停靠的楼层 |              | 在电梯运行结束后进行记录                            |
| 电梯的工作日志   |              | 打印电梯运行的完整流程：初始楼层，停留的楼层，最终停靠楼层，以及总计的运行时间 |

寻找以上已分类元素之间的关系，哪些成员需要计算得到，哪些成员从属于相同的对象，划分之后可以得到整个电梯部署系统的大体结构设计：






从这样的系统结构设计出发，使用TDD进行开发，先编写出测试案例，再逐步实现代码各模块的功能，进行最终的整合。

### 代码模块实现的主要难点

**1. 如何根据电梯的初始化信息和运行规则判断电梯初始运行的方向（上/下）？如何得到所有目标楼层的停靠顺序？**

按下的第一个目标楼层决定了电梯的起始运行方向：
- 第一个目标楼层 > 电梯当前所在的楼层：电梯向上运行
- 第二个目标楼层 < 电梯当前所在的楼层：电梯向下运行

当前电梯的起始运行方向已经决定：
- 电梯向上运行前往第一个目标楼层，途径任何目标楼层都停靠，到达第一个目标楼层后如果向上还有目标楼层，继续向上运行、停靠上方所有目标楼层，转头向下停靠剩余楼层
- 电梯向下运行前往第一个目标楼层，途径任何目标楼层都停靠，到达第一个目标楼层后如果向下还有目标楼层，继续向下运行、停靠下方所有目标楼层，转头向上停靠剩余楼层

由此可以整理出所有目标楼层停靠顺序的排列规则：



**2. 如何处理使用电梯请求的不同情形和细节？**

没有人按电梯时，电梯处于目标楼层切片为空的特殊情形，此时不需要对空切片进行排序，而是直接跳出排序成员函数，输出的结果为：最终停靠楼层即电梯的当前楼层；电梯运行总时长为0秒；写入相应工作日志字符串。

当有人按电梯时，首先应该检查输入的各数据是否合法，保证：
- 电梯总楼层数量 >= 电梯当前所在楼层
- 电梯总楼层数量 >= 任意目标楼层

如果数据不合法，跳出执行流程，存储并打印错误。

如果数据合法：
- 计算电梯走过的楼层总数，楼层总数即电梯运行总耗时（秒）
- 每当电梯停靠在一个目标楼层，当前所在楼层需要更新为此目标楼层，再向下一个目标楼层行进
- 将电梯的运行操作（开始运行、中途停靠、开门、关门、最终停靠等）写入工作日志字符串存储更新

## 电梯部署核心功能扩展

**电梯行进规则改进版**：电梯根据当前的位置，优先向目标多的方向行进，直到该方向全部送达后重新根据当前的电梯位置做相同规则的选择。

这里体现出面对对象编程的优越性，不需要对大量的原有代码进行复制/修改，可以在已有代码的基础上添加另一种运行规则，并设置一个开关，选择电梯在改进版规则下运行/在原有规则下运行，并对运行结果进行比较。

实现改进版的规则，只对电梯一开始的运行方向（上/下）产生影响，在已有代码中，需要对`setStartingDirection()`成员函数进行修改电梯向上/下运行的条件。同时，在输入电梯初始化数据时，需要指定电梯的运行规则，所以在对象`Elevator`上增加`upgrade`成员属性，通过对其`true`或`false`的设定来自动调度改进版/原有版的电梯运行规则。

### 加入扩展版功能的代码实现 [ >>> Code Link](https://github.com/AdaSheng07/ready.to.go/tree/main/000.homework/0004.elevatorDeployment)

